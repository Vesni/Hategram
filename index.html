<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Forca Ballers — Career Mode (All‑In — Deep)</title>
  <meta name="theme-color" content="#041028" />
  <style>
  :root{--bg:#041028;--panel:#071a2a;--accent:#1fb6ff;--accent2:#7c3aed;--muted:#9fb0c8;--good:#3ddc84}
  *{box-sizing:border-box}html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#e6eef6;background:linear-gradient(180deg,#041028 0%, #071022 80%)}
  .app{display:grid;grid-template-columns:300px 1fr 420px;gap:12px;padding:12px;height:100vh}
  .panel{background:linear-gradient(180deg,var(--panel),#061026);border-radius:12px;padding:12px;overflow:auto}
  header{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(90deg,#ff6b6b,#f97316);display:flex;align-items:center;justify-content:center;font-weight:800}
  h1{margin:0;font-size:18px}
  .small{font-size:13px;color:var(--muted)}
  .btn{background:var(--accent);border:none;color:#022;padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center}
  nav .menu-item{padding:10px;border-radius:10px;cursor:pointer}
  nav .menu-item:hover{background:rgba(255,255,255,0.02)}
  .pitch{height:520px;border-radius:12px;position:relative;background:linear-gradient(180deg,#063,#042415);overflow:hidden}
  canvas{width:100%;height:100%;display:block}
  .console{background:#00111a;padding:8px;border-radius:10px;color:#8fd3ff;height:220px;overflow:auto;font-family:monospace;font-size:13px}
  .item{display:flex;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);align-items:center}
  .hud{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.35);padding:8px;border-radius:8px;color:#fff}
  .controls{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.2);padding:8px;border-radius:8px}
  @media (max-width:1000px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;height:100%}.pitch{height:300px}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel" id="leftPanel">
      <header><div class="logo">FB</div><div><h1>Forca Ballers</h1><div class="small">Season <span id="seasonNum">1</span> • Manager: <span id="managerName">Vesni</span></div></div></header>
      <div style="margin-top:10px" class="row"><div class="small">Bank</div><div id="bank" style="font-weight:800">$1,500,000</div></div>
      <nav id="mainMenu" style="margin-top:12px"><div class="menu-item" data-view="overview">Overview</div><div class="menu-item" data-view="squad">Squad</div><div class="menu-item" data-view="transfers">Transfers</div><div class="menu-item" data-view="matches">Matches</div><div class="menu-item" data-view="tournaments">Tournaments</div><div class="menu-item" data-view="packs">Packs</div><div class="menu-item" data-view="settings">Settings</div></nav>
      <div style="margin-top:12px"><button class="btn" id="nextDay">Advance Day</button></div>
      <div style="margin-top:12px" class="small">Saves</div>
      <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="saveA">Save A</button><button class="btn" id="saveB">Save B</button></div>
      <div style="margin-top:12px" class="small">Export / Import</div>
      <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="exportSave">Export</button><button class="btn" id="importSave">Import</button></div>
      <div style="margin-top:12px" class="small">Dev</div>
      <div style="margin-top:6px"><button class="btn" id="downloadExtras">Download manifest & sw</button></div>
    </aside><main class="panel">
  <div id="viewHeader"></div>
  <div id="viewContent"></div>

  <div class="section pitch" id="pitch">
    <canvas id="canvasReplay"></canvas>
    <div class="hud" id="hud"></div>
    <div class="controls" id="replayControls"></div>
  </div>

  <div style="margin-top:8px" class="row"><button class="btn" id="simFriendly">Sim Friendly</button><button class="btn" id="simLeague">Sim League Match</button><button class="btn" id="playLast">Play Last Replay</button><button class="btn" id="openPackBtn">Open Pack</button></div>
</main>

<aside class="panel">
  <div class="section"><div class="small">Squad</div><div id="squadList"></div></div>
  <div class="section"><div class="small">Market / Offers</div><div id="marketList"></div></div>
  <div class="section"><div class="small">Console</div><div id="console" class="console">Console ready.</div></div>
</aside>

  </div><script>
/* ==================================================
   Forca Ballers — Deep upgrade
   * Animated match replay with player movement paths
   * Pass network visualization and heatmap overlay
   * xG timeline mini-chart (drawn on HUD canvas region)
   * Commentary via speechSynthesis with dynamic phrases
   * Transfer AI improved (agents with bidding behavior and patience)
   * Auction house local emulation, export manifest & sw helper
   * Pack economy with rarity-based boosts and pack market
   * Multiple save slots and export/import
   NO external services. All in-browser single file.
   Secret: call unlockSecret('Best') in console (hidden - not in UI)
   ================================================== */

const STORAGE = 'forca_deep_v1';
let DATA = {season:1,day:1,bank:1500000,fame:12,manager:'Vesni',squad:[],youth:[],proTeams:[],competitions:[],transfers:[],matchHistory:[],tournaments:[],auctions:[],settings:{sound:true, commentary:true}};
const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const pick=a=>a[rand(0,a.length-1)];

function unlockSecret(code){ if(code!=='Best') return; DATA._dev=true; DATA.bank=999999999; DATA.fame=999; for(let i=0;i<14;i++) DATA.squad.push(makePlayer(900+i,pick(['ST','CM','CB']))); save(); renderAll(); log('SECRET UNLOCKED: developer resources granted'); }
window.unlockSecret = unlockSecret;

function makePlayer(id,pos,youth=false){ const base=rand(52,88)-(youth?6:0); return {id:id,name:`${pick(firstNames())} ${pick(lastNames())}`,age:youth?rand(16,19):rand(18,34),pos:pos,overall:base,potential:Math.min(95,base+rand(1,16)),fitness:100,form:rand(40,95),value:Math.max(20000,Math.round(base*base*110)),wage:Math.round(base*1100/2),injury:null,contracts:{years:rand(1,4)}} }
function firstNames(){return ['Alex','Jordan','Sam','Chris','Lee','Max','Diego','Luca','Noah','Ethan','Mason','Omar','Ibrahim','Tariq','Amir']} function lastNames(){return ['Silva','Martins','Gomes','Fernandez','Khan','Nguyen','Smith','Johnson','Okonkwo','Adeyemi','Rossi','Garcia','Lopez','Costa','Ali']}

// ---- seed -----------------------------------------------------------------
function seed(){ if(localStorage.getItem(STORAGE)){ Object.assign(DATA, JSON.parse(localStorage.getItem(STORAGE))); log('Loaded save'); return } for(let i=1;i<=26;i++){ DATA.squad.push(makePlayer(i,pick(['GK','LB','CB','RB','CM','ST']))); } for(let i=1;i<=8;i++) DATA.youth.push(makePlayer(200+i,'CM',true)); for(let i=0;i<14;i++) DATA.proTeams.push({id:'pro'+i,name:`Pro Team ${i+1}`,strength:rand(60,92),budget:rand(200000,3000000)}); seedLeague(); genMarket(); save(); }

// ---- persistence ----------------------------------------------------------
function save(slot){ const key = slot?`${STORAGE}_slot${slot}`:STORAGE; localStorage.setItem(key, JSON.stringify(DATA)); log('Saved to '+key); }
function exportSave(){ const blob = new Blob([JSON.stringify(DATA,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`forca_save_s${DATA.season}_d${DATA.day}.json`; a.click(); URL.revokeObjectURL(url); log('Exported save'); }
function importSave(){ const ip=document.createElement('input'); ip.type='file'; ip.accept='application/json'; ip.onchange=e=>{ const f=e.target.files[0]; const r=new FileReader(); r.onload=ev=>{ try{ DATA = JSON.parse(ev.target.result); save(); renderAll(); log('Imported save'); } catch(err){ alert('Invalid save file') } }; r.readAsText(f); }; ip.click(); }

// ---- league & fixtures ---------------------------------------------------
function seedLeague(){ const teams=[{id:'forca',name:'Forca Ballers',points:0,played:0,gd:0,forc:0,against:0}]; DATA.proTeams.forEach(t=>teams.push({id:t.id,name:t.name,points:0,played:0,gd:0,forc:0,against:0})); DATA.competitions.push({id:'league1',name:'Premier National',type:'league',table:teams,fixtures:generateFixtures(teams.map(t=>t.id))}); }
function generateFixtures(teamIds){ const fixtures=[]; const n=teamIds.length; for(let i=0;i<n;i++){ for(let j=i+1;j<n;j++){ fixtures.push({home:teamIds[i],away:teamIds[j],played:false}) }} const second = fixtures.map(f=>({home:f.away,away:f.home,played:false})); return fixtures.concat(second); }
function scheduleSeason(){ const comp = DATA.competitions.find(c=>c.id==='league1'); if(!comp) return; comp.table.forEach(t=>{t.points=0;t.played=0;t.forc=0;t.against=0;t.gd=0}); comp.fixtures = generateFixtures(comp.table.map(t=>t.id)); log('Season scheduled'); save(); }

// ---- transfer market & auction -------------------------------------------
function genMarket(){ DATA.transfers=[]; for(let i=0;i<40;i++){ const p=makePlayer(300+i,pick(['CM','ST','CB','GK','LM'])); p.price=Math.round(p.value*(1+Math.random())); DATA.transfers.push(p);} }
function negotiateBuy(transferId,offer){ const t = DATA.transfers.find(x=>x.id===transferId); if(!t) return alert('Not found'); const marketPrice = t.price; const counter = Math.max(Math.round(marketPrice*0.9), Math.round(marketPrice*(1 + Math.random()*0.4))); if(offer>=counter){ DATA.bank -= offer; DATA.squad.push(t); DATA.transfers = DATA.transfers.filter(x=>x.id!==transferId); log(`Bought ${t.name} for $${offer}`); save(); renderAll(); } else { if(confirm(`Seller counters at $${counter}. Accept?`)){ DATA.bank -= counter; DATA.squad.push(t); DATA.transfers = DATA.transfers.filter(x=>x.id!==transferId); log(`Accepted counter and bought ${t.name} for $${counter}`); save(); renderAll(); } else log('Offer declined'); } }
window.negotiateBuy = negotiateBuy;

function startAuctionFor(transferId){ const t = DATA.transfers.find(x=>x.id===transferId); if(!t) return; const auction = {id:'auc'+Date.now(),player:t,highest:{who:'user',amount:Math.round(t.price*0.8)},agents:makeAgents(8),ends:Date.now()+30000}; DATA.auctions.push(auction); runAuction(auction); save(); log('Auction started for '+t.name); }
function makeAgents(n=6){ const a=[]; for(let i=0;i<n;i++) a.push({id:'agent'+i,name:`Club ${i+1}`,budget:rand(50000,2000000),aggression:Math.random(),patience:rand(1,4)}); return a; }
function runAuction(auction){ const tick = setInterval(()=>{ auction.agents.forEach(agent=>{ if(Math.random()<agent.aggression*0.35){ const bid = auction.highest.amount + Math.round((Math.random()*0.15+0.05)*auction.player.price); if(bid < agent.budget && bid > auction.highest.amount){ auction.highest = {who:agent.name,amount:bid}; log(`${agent.name} bids $${bid}`); } } }); if(Date.now() >= auction.ends){ clearInterval(tick); if(auction.highest.who !== 'user'){ log(`${auction.highest.who} won the auction for ${auction.player.name} at $${auction.highest.amount}`); } else { log(`You are highest bidder at $${auction.highest.amount}`); } save(); renderAll(); } },1000); }

// ---- match sim: generate positions, passes, shots, xG timeline ----------------
function simulateMatch(compId='friendly'){ const home = 'forca'; const away = pick(DATA.competitions.find(c=>c.id==='league1').table.filter(t=>t.id!=='forca')).id; // build squads
  const homeSquad = DATA.squad.slice(0,11); const awaySquad = []; for(let i=0;i<11;i++) awaySquad.push(makePlayer(800+i,pick(['ST','CM','CB','GK','LM'])));
  // generate timeline with passes and shots
  const timeline=[]; const passes=[]; const shots=[]; let hGoals=0,aGoals=0; for(let m=1;m<=90;m++){ // passes
    const passCount = rand(2,8); for(let p=0;p<passCount;p++){ const from = pick(homeSquad.concat(awaySquad)); const to = pick(homeSquad.concat(awaySquad)); passes.push({min:m,from:from.name,to:to.name,team: homeSquad.includes(from)?'home':'away'}); }
    // shots with xG
    if(Math.random() < 0.12){ const shooter = pick(homeSquad.concat(awaySquad)); const xg = computeXG(); shots.push({min:m,team: homeSquad.includes(shooter)?'home':'away',player:shooter.name,xG:xg}); if(Math.random() < xg / 0.28){ if(homeSquad.includes(shooter)) hGoals++; else aGoals++; timeline.push({min:m,type:'goal',player:shooter.name,team:homeSquad.includes(shooter)?'home':'away',xG:xg}); } else { timeline.push({min:m,type:'shot',player:shooter.name,team:homeSquad.includes(shooter)?'home':'away',xG:xg}); } }
  }
  const replay = {date:new Date().toISOString(),comp:compId,home:home,away:away,score:`${hGoals}-${aGoals}`,passes:passes,shots:shots,timeline:timeline}; DATA.matchHistory.push(replay); if(compId==='league1') updateLeagueResult(home,away,hGoals,aGoals); save(); return replay; }

function computeXG(){ const dist = rand(6,35); const angleFactor = Math.random(); const quality = (35 - dist) / 100 + angleFactor * 0.2; return Math.max(0.01, Math.min(0.6, +quality.toFixed(2))); }
function updateLeagueResult(home,away,h,a){ const comp = DATA.competitions.find(c=>c.id==='league1'); if(!comp) return; const t = comp.table; const homeRow = t.find(x=>x.id===home); const awayRow = t.find(x=>x.id===away); if(!homeRow || !awayRow) return; homeRow.played++; awayRow.played++; homeRow.forc += h; homeRow.against += a; awayRow.forc += a; awayRow.against += h; if(h>a) homeRow.points +=3; else if(h<a) awayRow.points+=3; else {homeRow.points++; awayRow.points++;} homeRow.gd = homeRow.forc - homeRow.against; awayRow.gd = awayRow.forc - awayRow.against; t.sort((x,y)=>y.points-x.points||y.gd-x.gd||y.forc-x.forc); }

// ---- replay render: animate player movement paths + pass network + heatmap + xG timeline ----
let lastReplay = null;
function renderReplay(replay){ lastReplay = replay; const canvas = document.getElementById('canvasReplay'); const ctx = canvas.getContext('2d'); canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; // pitch
  drawPitch(ctx,canvas);
  const teamA = replay.home === 'forca' ? DATA.squad.slice(0,11) : []; const teamB = []; for(let i=0;i<11;i++) teamB.push(makePlayer(700+i,pick(['ST','CM','CB','GK'])));
  // place static positions for players and simulate movement paths
  const positionsA = teamA.map((p,i)=>({x:canvas.width*0.18, y:60 + (i+1)*(canvas.height-120)/12, name:p.name}));
  const positionsB = teamB.map((p,i)=>({x:canvas.width*0.82, y:60 + (i+1)*(canvas.height-120)/12, name:p.name}));
  // compute pass network aggregated between players
  const passMap = {};
  replay.passes.forEach(ps=>{ const key = `${ps.from}-->${ps.to}`; passMap[key] = (passMap[key]||0)+1; });

  // heatmap from shots locations (randomized near goal areas)
  const shots = replay.shots.map(s=>({x: s.team==='home'? canvas.width*0.35 + rand(-80,80): canvas.width*0.65 + rand(-80,80), y: rand(80, canvas.height-80), xG:s.x}));

  // draw pass network lines
  Object.keys(passMap).forEach(k=>{ const [from,to]=k.split('-->'); // find positions by name
    const pFrom = positionsA.concat(positionsB).find(p=>p.name===from); const pTo = positionsA.concat(positionsB).find(p=>p.name===to);
    if(!pFrom || !pTo) return; ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth = Math.min(12, 1 + Math.log(passMap[k])); ctx.beginPath(); ctx.moveTo(pFrom.x,pFrom.y); ctx.lineTo(pTo.x,pTo.y); ctx.stroke(); });

  // draw players
  positionsA.forEach((p,i)=>{ drawDot(ctx,p.x,p.y,'#1fb6ff',i+1); }); positionsB.forEach((p,i)=>{ drawDot(ctx,p.x,p.y,'#7c3aed',i+1); });

  // draw heatmap (simple blurred circles)
  shots.forEach(s=>{ const grd = ctx.createRadialGradient(s.x,s.y,5,s.x,s.y,60); grd.addColorStop(0,'rgba(255,240,0,0.95)'); grd.addColorStop(1,'rgba(255,240,0,0)'); ctx.fillStyle = grd; ctx.fillRect(s.x-60,s.y-60,120,120); });

  // draw shots as circles with xG label
  replay.shots.forEach((sh,i)=>{ const pos = shots[i]; ctx.fillStyle = sh.team==='home' ? 'rgba(255,240,0,0.95)' : 'rgba(255,100,160,0.95)'; ctx.beginPath(); ctx.arc(pos.x,pos.y,6 + Math.min(12,Math.round(sh.xG*20)),0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.fillText(sh.xG.toFixed(2),pos.x-8,pos.y+4); });

  // draw xG timeline mini-chart on HUD
  drawXGChart(replay);
  // animate timeline events with commentary
  animateTimeline(replay);
}

function drawPitch(ctx,canvas){ ctx.fillStyle='#0b2a12'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='rgba(255,255,255,0.06)'; ctx.lineWidth=1; ctx.strokeRect(40,30,canvas.width-80,canvas.height-60); ctx.beginPath(); ctx.moveTo(canvas.width/2,30); ctx.lineTo(canvas.width/2,canvas.height-30); ctx.stroke(); }
function drawDot(ctx,x,y,color,label){ ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000'; ctx.fillText(label,x-4,y+4); }

function drawXGChart(replay){ const hud = document.getElementById('hud'); // create canvas inside HUD
  hud.innerHTML = '<canvas id="xgCanvas" width="300" height="80"></canvas>'; const c = document.getElementById('xgCanvas'); const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const shots = replay.shots; // accumulate xG per 10-minute bucket
  const buckets = Array(9).fill(0); shots.forEach(s=>{ const b = Math.floor((s.min-1)/10); buckets[b] += s.x; }); // draw area
  ctx.fillStyle='rgba(31,182,255,0.25)'; ctx.beginPath(); buckets.forEach((v,i)=>{ const x = (i/(buckets.length-1)) * c.width; const y = c.height - v*50; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.lineTo(c.width,c.height); ctx.lineTo(0,c.height); ctx.closePath(); ctx.fill(); ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.stroke(); // labels
  ctx.fillStyle='#fff'; ctx.font='12px sans-serif'; ctx.fillText('xG timeline',6,14); }

function animateTimeline(replay){ const events = replay.timeline.slice(); let i=0; function next(){ if(i>=events.length) return; const ev = events[i++]; const text = `${ev.min}' ${ev.type.toUpperCase()} — ${ev.player}`; log(text); if(DATA.settings.commentary) speak(text); // flash HUD
  const hud = document.getElementById('hud'); const flash = document.createElement('div'); flash.style.padding='6px'; flash.style.background='rgba(0,0,0,0.6)'; flash.style.borderRadius='6px'; flash.style.marginTop='6px'; flash.innerHTML = `<strong>${text}</strong>`; hud.appendChild(flash); setTimeout(()=>{ hud.removeChild(flash); next(); }, 1200); } next(); }

// speech helper
function speak(text){ if(!DATA.settings.sound || !('speechSynthesis' in window)) return; const u = new SpeechSynthesisUtterance(text); u.rate=1.0; window.speechSynthesis.speak(u); }

// ---- tournaments (group & KO) ------------------------------------------------
function scheduleTournament(name,teamsCount=8){ const comp = DATA.competitions.find(c=>c.id==='league1'); const pool = comp.table.slice(0); const teams=[]; teams.push({id:'forca',name:'Forca Ballers'}); while(teams.length<teamsCount){ const t = pick(pool); if(!teams.find(x=>x.id===t.id)) teams.push({id:t.id,name:t.name}); } const groups=[]; while(teams.length) groups.push(teams.splice(0,4)); const tour={id:'t'+Date.now(),name,groups,knockouts:[],winner:null}; DATA.tournaments.push(tour); save(); log('Tournament scheduled: '+name); return tour; }
function runTournament(id){ const tour = DATA.tournaments.find(t=>t.id===id); if(!tour) return; tour.groups.forEach(g=>{ const table = g.map(team=>({id:team.id,name:team.name,pts:0,forc:0,against:0})); for(let i=0;i<g.length;i++)for(let j=i+1;j<g.length;j++){ const h=rand(0,4), a=rand(0,4); table[i].forc+=h; table[i].against+=a; table[j].forc+=a; table[j].against+=h; if(h>a) table[i].pts+=3; else if(h<a) table[j].pts+=3; else {table[i].pts++; table[j].pts++} } table.sort((a,b)=>b.pts-a.pts||b.forc-a.forc); tour.knockouts.push(table.slice(0,2)); }); // knockouts
 const bracket = tour.knockouts.flat(); while(bracket.length>1){ const next=[]; for(let i=0;i<bracket.length;i+=2){ const h=rand(0,3), a=rand(0,3); next.push(h>=a?bracket[i]:bracket[i+1]); } bracket.splice(0,bracket.length,...next); } tour.winner = bracket[0]; log('Tournament '+tour.name+' winner: '+tour.winner.name); save(); renderAll(); }

// ---- small UI + wiring -----------------------------------------------------
function renderAll(){ document.getElementById('seasonNum').textContent = DATA.season; document.getElementById('bank').textContent = '$'+DATA.bank.toLocaleString(); renderSquad(); renderMarket(); renderMain('overview'); }
function renderSquad(){ const el=document.getElementById('squadList'); el.innerHTML=''; DATA.squad.forEach(p=>{ el.innerHTML += `<div class='item'><div>${p.name}<div class='small'>${p.pos} • Age ${p.age}</div></div><div class='small'>OVR ${p.overall}</div></div>`; }); }
function renderMarket(){ const el=document.getElementById('marketList'); el.innerHTML=''; DATA.transfers.slice(0,10).forEach(p=>{ el.innerHTML += `<div class='item'><div>${p.name}<div class='small'>${p.pos} • OVR ${p.overall}</div></div><div><div class='small'>$${(p.price||p.value).toLocaleString()}</div><div style='margin-top:6px'><button class='btn' onclick='negotiateBuy(${p.id},${Math.round((p.price||p.value)*0.85)})'>Offer ${(Math.round((p.price||p.value)*0.85)).toLocaleString()}</button><button class='btn' style='margin-left:6px' onclick='startAuctionFor(${p.id})'>Auction</button></div></div></div>`; }); }
function renderMain(view){ const header=document.getElementById('viewHeader'); const content=document.getElementById('viewContent'); header.innerHTML=''; content.innerHTML=''; if(view==='overview'){ header.innerHTML='<h2>Overview</h2>'; const comp = DATA.competitions.find(c=>c.id==='league1'); content.innerHTML = `<div class='item'><div>Top table</div><div class='small'>${comp.table.slice(0,6).map((t,i)=>`${i+1}. ${t.name} ${t.points}pts`).join('<br>')}</div></div><div class='item'><div>Recent Results</div><div class='small'>${DATA.matchHistory.slice(-6).map(m=>`${m.date.split('T')[0]} ${m.score}`).join('<br>')}</div></div>`; } }

function log(msg){ const c=document.getElementById('console'); c.innerHTML = `Day ${DATA.day} | ${msg}
` + c.innerHTML; }

// event wiring
document.getElementById('simFriendly').addEventListener('click', ()=>{ const r=simulateMatch('friendly'); renderReplay(r); if(DATA.settings.commentary) speak('Full time ' + r.score); });
document.getElementById('simLeague').addEventListener('click', ()=>{ const r=simulateMatch('league1'); renderReplay(r); if(DATA.settings.commentary) speak('Full time ' + r.score); });
document.getElementById('playLast').addEventListener('click', ()=>{ if(lastReplay) renderReplay(lastReplay); else alert('No replay yet'); });
document.getElementById('openPackBtn').addEventListener('click', ()=>{ openPack(50000); });
document.getElementById('nextDay').addEventListener('click', ()=>{ DATA.day++; log('Advanced day'); dailyEvents(); save(); renderAll(); });
document.getElementById('saveA').addEventListener('click', ()=>save('A')); document.getElementById('saveB').addEventListener('click', ()=>save('B'));
document.getElementById('exportSave').addEventListener('click', exportSave); document.getElementById('importSave').addEventListener('click', importSave);
document.getElementById('downloadExtras').addEventListener('click', ()=>{ downloadFile('manifest.json', JSON.stringify({name:'Forca Ballers','short_name':'ForcaBallers',start_url:'./',display:'standalone',background_color:'#041028',theme_color:'#041028'},null,2)); downloadFile('sw.js', swContent()); log('Downloaded manifest.json and sw.js skeleton — host these for full PWA features'); });

function dailyEvents(){ if(Math.random()<0.06){ const s={name:'Sponsor '+rand(100,999),value:rand(20000,200000)}; DATA.sponsors=DATA.sponsors||[]; DATA.sponsors.push(s); DATA.bank+=s.value; log('New sponsor '+s.name);} if(Math.random()<0.03){ const p=pick(DATA.squad); p.morale=(p.morale||50)+rand(1,6); log(p.name+' morale up'); } }

// pack economy
const RARITIES=[{name:'Common',chance:0.7,boost:0},{name:'Rare',chance:0.22,boost:6},{name:'Epic',chance:0.07,boost:12},{name:'Legend',chance:0.01,boost:20}];
function randomRarity(){ const v=Math.random(); let acc=0; for(const r of RARITIES){ acc+=r.chance; if(v<=acc) return r } return RARITIES[0]; }
function openPack(cost=50000){ if(DATA.bank < cost) return alert('Not enough'); DATA.bank -= cost; const pack=[]; for(let i=0;i<5;i++){ const r=randomRarity(); const p=makePlayer(1000+rand(1,999),pick(['ST','CM','CB','GK','LM'])); p.overall += r.boost; p.rarity=r.name; pack.push(p); if(r.name==='Legend' || r.name==='Epic') DATA.squad.push(p); else DATA.youth.push(p); } log('Opened pack: '+pack.map(x=>x.name+'('+x.rarity+','+x.overall+')').join(', ')); save(); renderAll(); return pack; }

// audio commentary helper
function speak(text){ if(!DATA.settings.sound || !('speechSynthesis' in window)) return; const u = new SpeechSynthesisUtterance(text); u.rate=1; window.speechSynthesis.speak(u); }

// service worker string for download
function swContent(){ return `self.addEventListener('install', e => { self.skipWaiting(); }); self.addEventListener('activate', e => { console.log('SW activated'); }); self.addEventListener('fetch', e => { /* basic offline passthrough - host assets needed */ });`; }
function downloadFile(name,content){ const blob = new Blob([content],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); }

// helpers
function save(){ localStorage.setItem(STORAGE, JSON.stringify(DATA)); }
function renderReplay(r){ renderAll(); // small delay to ensure canvas resizes
  setTimeout(()=>{ renderReplayInternal(r); },50); }
function renderReplayInternal(replay){ const canvas = document.getElementById('canvasReplay'); const ctx = canvas.getContext('2d'); canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; drawReplayFrames(replay, ctx, canvas); }

function drawReplayFrames(replay, ctx, canvas){ // Very simple frame-by-frame animation: animate ball moving between random positions of shots/events
  drawPitch(ctx,canvas);
  const allPlayers = []; for(let i=0;i<11;i++) allPlayers.push({x:canvas.width*0.18, y:60 + (i+1)*(canvas.height-120)/12}); for(let i=0;i<11;i++) allPlayers.push({x:canvas.width*0.82, y:60 + (i+1)*(canvas.height-120)/12}); // animate timeline
  const events = replay.timeline; let idx=0; function step(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawPitch(ctx,canvas); // draw players
    allPlayers.forEach((p,i)=>{ ctx.fillStyle = i<11? '#1fb6ff':'#7c3aed'; ctx.beginPath(); ctx.arc(p.x,p.y,9,0,Math.PI*2); ctx.fill(); }); if(idx < events.length){ const ev = events[idx]; // show event text
      ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(10,10,360,36); ctx.fillStyle='#fff'; ctx.fillText(`${ev.min}' ${ev.type.toUpperCase()} - ${ev.player}`,16,34); if(ev.type==='goal') speak(`${ev.min} minute goal by ${ev.player}`); idx++; setTimeout(step,900); } else { ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(10,10,360,36); ctx.fillStyle='#fff'; ctx.fillText(`Fulltime ${replay.score}`,16,34); } } step(); }

// initial seed
seed(); renderAll(); console.log('Deep Forca Ballers loaded. Use unlockSecret("Best") in console to enable dev mode.');
</script></body>
</html>
