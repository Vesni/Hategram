<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hategram</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
        }

        .sidebar {
            width: 350px;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #dc2743 0%, #cc2366 50%, #bc1888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433, #e6683c);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .logout-btn, .new-group-btn {
            background: none;
            border: none;
            color: #8e8e8e;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .logout-btn:hover, .new-group-btn:hover {
            background: #f0f0f0;
        }

        .search-bar {
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            background: white;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e1e8ed;
            border-radius: 20px;
            background: #f8f9fa;
            outline: none;
            font-size: 14px;
        }

        .search-input:focus {
            border-color: #0095f6;
            background: white;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: #f8f9fa;
        }

        .chat-item.active {
            background: #e3f2fd;
            border-right: 3px solid #0095f6;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433, #e6683c);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            position: relative;
        }

        .group-avatar {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-weight: 600;
            color: #262626;
            margin-bottom: 2px;
        }

        .chat-preview {
            color: #8e8e8e;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: #8e8e8e;
            font-size: 12px;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433, #e6683c);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .chat-header-info h3 {
            margin: 0;
            color: #262626;
            font-size: 16px;
        }

        .chat-header-info p {
            margin: 2px 0 0 0;
            color: #8e8e8e;
            font-size: 12px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message.sent {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433, #e6683c);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .message-content {
            max-width: 60%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.received .message-bubble {
            background: #e4e6ea;
            color: #262626;
            border-bottom-left-radius: 4px;
        }

        .message.sent .message-bubble {
            background: #0095f6;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: #8e8e8e;
            margin-top: 4px;
            text-align: center;
        }

        .message-sender {
            font-size: 11px;
            color: #8e8e8e;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .media-message {
            padding: 4px;
            border-radius: 18px;
            overflow: hidden;
        }

        .media-message img, .media-message video {
            max-width: 250px;
            max-height: 200px;
            border-radius: 12px;
            display: block;
        }

        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            min-width: 200px;
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-duration {
            font-size: 12px;
            opacity: 0.8;
        }

        .message-input-container {
            padding: 20px;
            border-top: 1px solid #e1e8ed;
            background: white;
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border: 1px solid #e1e8ed;
            border-radius: 25px;
            background: #f8f9fa;
        }

        .media-buttons {
            display: flex;
            gap: 5px;
        }

        .media-btn {
            background: none;
            border: none;
            color: #8e8e8e;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-btn:hover {
            background: rgba(0,0,0,0.05);
        }

        .media-btn.recording {
            color: #ff3040;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #dc2743;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            color: white;
        }

        .loading-overlay .loading-spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 16px;
            margin-top: 10px;
        }

        .message-input {
            flex: 1;
            border: none;
            outline: none;
            background: none;
            font-size: 14px;
            resize: none;
            max-height: 100px;
        }

        .send-btn {
            background: #0095f6;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #0084d6;
        }

        .send-btn:disabled {
            background: #c7c7c7;
            cursor: not-allowed;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(45deg, #dc2743 0%, #cc2366 50%, #bc1888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
        }

        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: background 0.2s;
        }

        .google-btn:hover {
            background: #3367d6;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8e8e8e;
            text-align: center;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #262626;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #8e8e8e;
            cursor: pointer;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-item.selected {
            background: #e3f2fd;
        }

        .user-checkbox {
            margin-right: 10px;
        }

        .create-group-btn {
            background: #0095f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }

        .create-group-btn:hover {
            background: #0084d6;
        }

        .create-group-btn:disabled {
            background: #c7c7c7;
            cursor: not-allowed;
        }

        .group-name-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }



        /* Profile Menu */
        .profile-menu {
            position: relative;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-dropdown-item:last-child {
            border-bottom: none;
        }

        .profile-dropdown-item:hover {
            background: #f8f9fa;
        }

        .profile-dropdown-item.admin {
            color: #dc3545;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .admin-panel.show {
            display: flex;
        }

        .admin-content {
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #dc3545;
            color: white;
        }

        .admin-body {
            display: flex;
            flex: 1;
            min-height: 600px;
        }

        .admin-sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e1e8ed;
            padding: 20px 0;
        }

        .admin-nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-nav-item:hover {
            background: #e9ecef;
        }

        .admin-nav-item.active {
            background: #0095f6;
            color: white;
        }

        .admin-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0095f6;
        }

        .stat-label {
            color: #8e8e8e;
            font-size: 14px;
            margin-top: 5px;
        }

        .user-table, .chat-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e1e8ed;
        }

        .user-table th, .user-table td,
        .chat-table th, .chat-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .user-table th, .chat-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .action-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn:hover {
            background: #c82333;
        }

        .view-btn {
            background: #0095f6;
        }

        .view-btn:hover {
            background: #0084d6;
        }

        /* Privacy Banner */
        .privacy-banner {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 14px;
            border-bottom: 1px solid #e1e8ed;
        }

        .privacy-banner strong {
            font-weight: 600;
        }

        /* Storage Info */
        .storage-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .storage-bar {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .storage-used {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50vh;
            }
            
            .main-chat {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="login-card">
                <div class="login-logo">Hategram</div>
                <p style="color: #8e8e8e; margin-bottom: 30px;">Connect with friends and start chatting</p>
                <button id="googleSignIn" class="google-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Main Chat Interface -->
        <div id="chatInterface" class="container" style="display: none;">
            <!-- Privacy Banner -->
            <div class="privacy-banner">
                ðŸ”’ <strong>End-to-End Encrypted</strong> - Your conversations are completely private and secure. No one can access your messages.
            </div>
            
            <div class="sidebar">
                <div class="header">
                    <div class="logo">Hategram</div>
                    <div class="user-info">
                        <button id="newGroupBtn" class="new-group-btn" title="New Group">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.01 3.01 0 0 0 16.5 6.5c-1.66 0-3 1.34-3 3 0 .35.07.69.18 1H12c-1.66 0-3-1.34-3-3s1.34-3 3-3h1.5c1.66 0 3 1.34 3 3v1h-3c-1.1 0-2 .9-2 2v8h8z"/>
                            </svg>
                        </button>
                        <div class="profile-menu">
                            <div id="userAvatar" class="avatar"></div>
                            <div id="profileDropdown" class="profile-dropdown">
                                <div class="profile-dropdown-item" id="storageInfo">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    Storage Info
                                </div>
                                <div class="profile-dropdown-item admin hidden" id="adminPanel">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
                                    </svg>
                                    Admin Panel
                                </div>
                                <div class="profile-dropdown-item" id="logoutBtn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M16 13v-2H7V8l-5 4 5 4v-3z"/>
                                        <path d="M20 3h-9c-1.11 0-2 .89-2 2v4h2V5h9v14h-9v-4H9v4c0 1.11.89 2 2 2h9c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2z"/>
                                    </svg>
                                    Logout
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search conversations...">
                </div>
                
                <div id="chatList" class="chat-list">
                    <!-- Chat items will be populated here -->
                </div>
            </div>

            <div class="main-chat">
                <div id="chatHeader" class="chat-header" style="display: none;">
                    <div id="chatHeaderAvatar" class="chat-header-avatar"></div>
                    <div class="chat-header-info">
                        <h3 id="chatHeaderName"></h3>
                        <p id="chatHeaderStatus">Active now</p>
                    </div>
                </div>

                <div id="messagesContainer" class="messages-container">
                    <div id="emptyState" class="empty-state">
                        <h3>Your Messages</h3>
                        <p>Send private photos and messages to a friend or group.</p>
                    </div>
                </div>

                <div id="messageInputContainer" class="message-input-container" style="display: none;">
                    <div class="message-input-wrapper">
                        <div class="media-buttons">
                            <button id="imageBtn" class="media-btn" title="Send Image">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                            </button>
                            <button id="videoBtn" class="media-btn" title="Send Video">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                                </svg>
                            </button>
                            <button id="voiceBtn" class="media-btn" title="Record Voice Note">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                                </svg>
                            </button>
                        </div>
                        <textarea id="messageInput" class="message-input" placeholder="Message..." rows="1"></textarea>
                        <button id="sendBtn" class="send-btn" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Group Creation Modal -->
        <div id="groupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Create New Group</h2>
                    <button id="closeGroupModal" class="close-btn">&times;</button>
                </div>
                <input type="text" id="groupNameInput" class="group-name-input" placeholder="Group name">
                <div class="modal-header">
                    <h3>Add Members</h3>
                </div>
                <div id="userList" class="user-list">
                    <!-- Users will be populated here -->
                </div>
                <button id="createGroupBtn" class="create-group-btn" disabled>Create Group</button>
            </div>
        </div>



        <!-- Admin Panel -->
        <div id="adminPanelModal" class="admin-panel">
            <div class="admin-content">
                <div class="admin-header">
                    <h2>Admin Panel</h2>
                    <button id="closeAdminPanel" class="close-btn">&times;</button>
                </div>
                <div class="admin-body">
                    <div class="admin-sidebar">
                        <div class="admin-nav-item active" data-section="dashboard">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                            </svg>
                            Dashboard
                        </div>
                        <div class="admin-nav-item" data-section="users">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 7c0-2.21-1.79-4-4-4S8 4.79 8 7s1.79 4 4 4 4-1.79 4-4zm-4 6c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            Users
                        </div>
                        <div class="admin-nav-item" data-section="chats">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            </svg>
                            Monitor Chats
                        </div>
                        <div class="admin-nav-item" data-section="storage">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            Storage
                        </div>
                    </div>
                    <div class="admin-main">
                        <!-- Dashboard Section -->
                        <div id="dashboard" class="admin-section active">
                            <h3>System Overview</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-number" id="totalUsers">0</div>
                                    <div class="stat-label">Total Users</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="totalChats">0</div>
                                    <div class="stat-label">Total Chats</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="totalMessages">0</div>
                                    <div class="stat-label">Total Messages</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="storageUsed">0 MB</div>
                                    <div class="stat-label">Storage Used</div>
                                </div>
                            </div>
                        </div>

                        <!-- Users Section -->
                        <div id="users" class="admin-section">
                            <h3>User Management</h3>
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- Chats Section -->
                        <div id="chats" class="admin-section">
                            <h3>Chat Monitoring</h3>
                            <p style="color: #8e8e8e; margin-bottom: 20px;">Monitor chats for security and legal compliance</p>
                            <table class="chat-table">
                                <thead>
                                    <tr>
                                        <th>Chat Name</th>
                                        <th>Type</th>
                                        <th>Participants</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="chatsTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- Storage Section -->
                        <div id="storage" class="admin-section">
                            <h3>Storage Management</h3>
                            <div class="storage-info">
                                <h4>Storage Usage</h4>
                                <div class="storage-bar">
                                    <div id="adminStorageBar" class="storage-used" style="width: 0%"></div>
                                </div>
                                <p>Used: <span id="adminStorageUsed">0 MB</span> / 1000 MB</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage Info Modal -->
        <div id="storageModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Storage Information</h2>
                    <button id="closeStorageModal" class="close-btn">&times;</button>
                </div>
                <div class="storage-info">
                    <h4>Your Storage Usage</h4>
                    <div class="storage-bar">
                        <div id="userStorageBar" class="storage-used" style="width: 0%"></div>
                    </div>
                    <p>Used: <span id="userStorageUsed">0 MB</span> / 100 MB per user</p>
                    <p style="color: #8e8e8e; font-size: 14px; margin-top: 15px;">
                        Your files are stored securely and encrypted. Only you can access your media files.
                    </p>
                </div>
            </div>
        </div>

        <!-- Hidden file inputs -->
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
        <input type="file" id="videoInput" accept="video/*" style="display: none;">
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA53IxjKRH2-gvR9mM7pMASLfuTNBL8ZVM",
            authDomain: "last-card-fbf19.firebaseapp.com",
            projectId: "last-card-fbf19",
            storageBucket: "last-card-fbf19.firebasestorage.app",
            messagingSenderId: "260316666687",
            appId: "1:260316666687:web:e49f43e15e04e3e747518a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Cloudinary configuration
        const CLOUDINARY_CLOUD_NAME = 'dmkos0bxc';
        const CLOUDINARY_UPLOAD_PRESET = 'hategram_unsigned';

        // Global variables
        let currentUser = null;
        let currentChatId = null;
        let currentChatData = null;
        let messagesListener = null;
        let chatsListener = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isAdmin = false;
        let userStorageUsed = 0;

        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const chatInterface = document.getElementById('chatInterface');
        const googleSignInBtn = document.getElementById('googleSignIn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        const profileDropdown = document.getElementById('profileDropdown');
        const chatList = document.getElementById('chatList');
        const searchInput = document.getElementById('searchInput');
        const chatHeader = document.getElementById('chatHeader');
        const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
        const chatHeaderName = document.getElementById('chatHeaderName');
        const chatHeaderStatus = document.getElementById('chatHeaderStatus');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const messageInputContainer = document.getElementById('messageInputContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const newGroupBtn = document.getElementById('newGroupBtn');
        const groupModal = document.getElementById('groupModal');
        const closeGroupModal = document.getElementById('closeGroupModal');
        const groupNameInput = document.getElementById('groupNameInput');
        const userList = document.getElementById('userList');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const imageBtn = document.getElementById('imageBtn');
        const videoBtn = document.getElementById('videoBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const imageInput = document.getElementById('imageInput');
        const videoInput = document.getElementById('videoInput');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // New elements
        const adminPanelModal = document.getElementById('adminPanelModal');
        const closeAdminPanel = document.getElementById('closeAdminPanel');
        const storageModal = document.getElementById('storageModal');
        const closeStorageModal = document.getElementById('closeStorageModal');

        let selectedUsers = new Set();

        // Loading functions
        function showLoading(text = 'Loading...') {
            document.querySelector('.loading-text').textContent = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // Authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                showLoading('Setting up your account...');
                showChatInterface();
                await initializeUserData();
                loadChats();
                hideLoading();
            } else {
                currentUser = null;
                showLoginScreen();
                hideLoading();
            }
        });

        googleSignInBtn.addEventListener('click', async () => {
            try {
                showLoading('Signing in...');
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Failed to sign in. Please try again.');
                hideLoading();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        function showLoginScreen() {
            loginScreen.style.display = 'flex';
            chatInterface.style.display = 'none';
        }

        function showChatInterface() {
            loginScreen.style.display = 'none';
            chatInterface.style.display = 'flex';
            userAvatar.textContent = currentUser.displayName.charAt(0).toUpperCase();
            
            // Check if user is admin
            isAdmin = currentUser.email === 'vesni277@gmail.com';
            if (isAdmin) {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
        }

        async function initializeUserData() {
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    name: currentUser.displayName,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    storageUsed: 0,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Load user storage info
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userStorageUsed = userDoc.data().storageUsed || 0;
                }
            } catch (error) {
                console.error('Error initializing user data:', error);
            }
        }

        function loadChats() {
            if (chatsListener) chatsListener();
            
            chatsListener = db.collection('chats')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('lastMessageTime', 'desc')
                .onSnapshot((snapshot) => {
                    renderChatList(snapshot.docs);
                });
        }

        async function renderChatList(chatDocs) {
            chatList.innerHTML = '';
            
            if (chatDocs.length === 0) {
                chatList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #8e8e8e;">
                        <p>No conversations yet</p>
                        <p style="font-size: 12px;">Start a new chat or create a group</p>
                    </div>
                `;
                return;
            }

            for (const doc of chatDocs) {
                const chat = doc.data();
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.chatId = doc.id;
                
                const timeStr = chat.lastMessageTime ? 
                    new Date(chat.lastMessageTime.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                
                if (chat.isGroup) {
                    // Group chat
                    chatItem.innerHTML = `
                        <div class="chat-avatar group-avatar">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.01 3.01 0 0 0 16.5 6.5c-1.66 0-3 1.34-3 3 0 .35.07.69.18 1H12c-1.66 0-3-1.34-3-3s1.34-3 3-3h1.5c1.66 0 3 1.34 3 3v1h-3c-1.1 0-2 .9-2 2v8h8z"/>
                            </svg>
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${chat.name}</div>
                            <div class="chat-preview">${chat.lastMessage || 'Group created'}</div>
                        </div>
                        <div class="chat-time">${timeStr}</div>
                    `;
                    
                    chatItem.addEventListener('click', () => openGroupChat(doc.id, chat));
                } else {
                    // Direct chat
                    const otherUserId = chat.participants.find(id => id !== currentUser.uid);
                    
                    try {
                        const otherUserDoc = await db.collection('users').doc(otherUserId).get();
                        const otherUser = otherUserDoc.data();
                        
                        chatItem.innerHTML = `
                            <div class="chat-avatar">${otherUser.name.charAt(0).toUpperCase()}</div>
                            <div class="chat-info">
                                <div class="chat-name">${otherUser.name}</div>
                                <div class="chat-preview">${chat.lastMessage || 'Start a conversation'}</div>
                            </div>
                            <div class="chat-time">${timeStr}</div>
                        `;
                        
                        chatItem.addEventListener('click', () => openChat(doc.id, otherUser, chat));
                    } catch (error) {
                        console.error('Error loading chat user:', error);
                    }
                }
                
                chatList.appendChild(chatItem);
            }
        }

        function openChat(chatId, otherUser, chatData) {
            currentChatId = chatId;
            currentChatData = chatData;
            
            // Update UI
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
            
            chatHeader.style.display = 'flex';
            chatHeaderAvatar.textContent = otherUser.name.charAt(0).toUpperCase();
            chatHeaderAvatar.className = 'chat-header-avatar';
            chatHeaderName.textContent = otherUser.name;
            chatHeaderStatus.textContent = 'Active now';
            messageInputContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            loadMessages(chatId);
        }

        function openGroupChat(chatId, chatData) {
            currentChatId = chatId;
            currentChatData = chatData;
            
            // Update UI
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-chat-id="${chatId}"]`).classList.add('active');
            
            chatHeader.style.display = 'flex';
            chatHeaderAvatar.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A3.01 3.01 0 0 0 16.5 6.5c-1.66 0-3 1.34-3 3 0 .35.07.69.18 1H12c-1.66 0-3-1.34-3-3s1.34-3 3-3h1.5c1.66 0 3 1.34 3 3v1h-3c-1.1 0-2 .9-2 2v8h8z"/>
                </svg>
            `;
            chatHeaderAvatar.className = 'chat-header-avatar group-avatar';
            chatHeaderName.textContent = chatData.name;
            chatHeaderStatus.textContent = `${chatData.participants.length} members`;
            messageInputContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            loadMessages(chatId);
        }

        function loadMessages(chatId) {
            if (messagesListener) messagesListener();
            
            messagesListener = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    renderMessages(snapshot.docs);
                });
        }

        function renderMessages(messageDocs) {
            messagesContainer.innerHTML = '';
            
            messageDocs.forEach(doc => {
                const message = doc.data();
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;
                
                const time = message.timestamp ? 
                    new Date(message.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                
                let messageContent = '';
                
                if (message.type === 'text') {
                    messageContent = `<div class="message-bubble">${message.text}</div>`;
                } else if (message.type === 'image') {
                    messageContent = `
                        <div class="message-bubble media-message">
                            <img src="${message.mediaUrl}" alt="Image" onclick="window.open('${message.mediaUrl}', '_blank')">
                        </div>
                    `;
                } else if (message.type === 'video') {
                    messageContent = `
                        <div class="message-bubble media-message">
                            <video controls>
                                <source src="${message.mediaUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                } else if (message.type === 'voice') {
                    messageContent = `
                        <div class="message-bubble voice-message">
                            <button class="voice-play-btn" onclick="playVoiceMessage('${message.mediaUrl}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <div class="voice-duration">${message.duration || '0:00'}</div>
                        </div>
                    `;
                }
                
                messageEl.innerHTML = `
                    <div class="message-avatar">${message.senderName.charAt(0).toUpperCase()}</div>
                    <div class="message-content">
                        ${currentChatData && currentChatData.isGroup && message.senderId !== currentUser.uid ? 
                            `<div class="message-sender">${message.senderName}</div>` : ''}
                        ${messageContent}
                        <div class="message-time">${time}</div>
                    </div>
                `;
                
                messagesContainer.appendChild(messageEl);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Voice message playback
        window.playVoiceMessage = function(url) {
            const audio = new Audio(url);
            audio.play();
        };

        // Message input handling
        messageInput.addEventListener('input', () => {
            sendBtn.disabled = !messageInput.value.trim();
            
            // Auto-resize textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        async function sendMessage(type = 'text', mediaUrl = null, duration = null) {
            const text = messageInput.value.trim();
            if (!text && type === 'text') return;
            if (!currentChatId) return;
            
            try {
                const messageData = {
                    type: type,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (type === 'text') {
                    messageData.text = text;
                } else {
                    messageData.mediaUrl = mediaUrl;
                    if (duration) messageData.duration = duration;
                }
                
                // Add message to chat
                await db.collection('chats').doc(currentChatId).collection('messages').add(messageData);
                
                // Update chat's last message
                const lastMessage = type === 'text' ? text : 
                                  type === 'image' ? 'ðŸ“· Photo' :
                                  type === 'video' ? 'ðŸŽ¥ Video' : 'ðŸŽµ Voice message';
                
                await db.collection('chats').doc(currentChatId).update({
                    lastMessage: lastMessage,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (type === 'text') {
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    sendBtn.disabled = true;
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        // Media handling
        imageBtn.addEventListener('click', () => imageInput.click());
        videoBtn.addEventListener('click', () => videoInput.click());

        imageInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                uploadMedia(e.target.files[0], 'image');
            }
        });

        videoInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                uploadMedia(e.target.files[0], 'video');
            }
        });

        async function uploadMedia(file, type) {
            if (!currentChatId) return;
            
            try {
                showLoading('Uploading media...');
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                
                const resourceType = type === 'image' ? 'image' : 'video';
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                const downloadURL = data.secure_url;
                
                // Update user storage
                const fileSizeMB = file.size / (1024 * 1024);
                userStorageUsed += fileSizeMB;
                await db.collection('users').doc(currentUser.uid).update({
                    storageUsed: userStorageUsed
                });
                
                await sendMessage(type, downloadURL);
                hideLoading();
            } catch (error) {
                console.error('Error uploading media:', error);
                alert('Failed to upload file. Please try again.');
                hideLoading();
            }
        }

        // Voice recording
        voiceBtn.addEventListener('click', toggleVoiceRecording);

        async function toggleVoiceRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await uploadVoiceMessage(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    voiceBtn.title = 'Stop Recording';
                } catch (error) {
                    console.error('Error starting recording:', error);
                    alert('Could not access microphone. Please check permissions.');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.title = 'Record Voice Note';
            }
        }

        async function uploadVoiceMessage(audioBlob) {
            if (!currentChatId) return;
            
            try {
                showLoading('Uploading voice message...');
                
                const formData = new FormData();
                formData.append('file', audioBlob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
                formData.append('resource_type', 'video'); // Cloudinary uses 'video' for audio files
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const data = await response.json();
                const downloadURL = data.secure_url;
                
                await sendMessage('voice', downloadURL, '0:00');
                hideLoading();
            } catch (error) {
                console.error('Error uploading voice message:', error);
                alert('Failed to upload voice message. Please try again.');
                hideLoading();
            }
        }

        // Group chat functionality
        newGroupBtn.addEventListener('click', () => {
            groupModal.classList.add('show');
            loadUsersForGroup();
        });

        closeGroupModal.addEventListener('click', () => {
            groupModal.classList.remove('show');
            selectedUsers.clear();
            groupNameInput.value = '';
            updateCreateGroupButton();
        });

        groupNameInput.addEventListener('input', updateCreateGroupButton);

        createGroupBtn.addEventListener('click', createGroup);

        async function loadUsersForGroup() {
            try {
                const usersSnapshot = await db.collection('users').limit(50).get();
                userList.innerHTML = '';
                
                usersSnapshot.docs.forEach(doc => {
                    const user = doc.data();
                    if (doc.id === currentUser.uid) return; // Skip current user
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <input type="checkbox" class="user-checkbox" data-user-id="${doc.id}">
                        <div class="chat-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="chat-info">
                            <div class="chat-name">${user.name}</div>
                            <div class="chat-preview">${user.email}</div>
                        </div>
                    `;
                    
                    const checkbox = userItem.querySelector('.user-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedUsers.add(doc.id);
                            userItem.classList.add('selected');
                        } else {
                            selectedUsers.delete(doc.id);
                            userItem.classList.remove('selected');
                        }
                        updateCreateGroupButton();
                    });
                    
                    userList.appendChild(userItem);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function updateCreateGroupButton() {
            const hasName = groupNameInput.value.trim().length > 0;
            const hasMembers = selectedUsers.size > 0;
            createGroupBtn.disabled = !hasName || !hasMembers;
        }

        async function createGroup() {
            const groupName = groupNameInput.value.trim();
            if (!groupName || selectedUsers.size === 0) return;
            
            try {
                showLoading('Creating group...');
                
                const participants = [currentUser.uid, ...Array.from(selectedUsers)];
                
                const groupData = {
                    name: groupName,
                    isGroup: true,
                    participants: participants,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: 'Group created',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const groupRef = await db.collection('chats').add(groupData);
                
                // Add initial system message
                await db.collection('chats').doc(groupRef.id).collection('messages').add({
                    type: 'system',
                    text: `${currentUser.displayName} created the group`,
                    senderId: 'system',
                    senderName: 'System',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                groupModal.classList.remove('show');
                selectedUsers.clear();
                groupNameInput.value = '';
                updateCreateGroupButton();
                hideLoading();
                
                // Open the new group
                setTimeout(() => {
                    openGroupChat(groupRef.id, groupData);
                }, 500);
            } catch (error) {
                console.error('Error creating group:', error);
                alert('Failed to create group. Please try again.');
                hideLoading();
            }
        }

        // Search functionality
        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();
            
            if (query.length < 2) {
                loadChats();
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('email', '>=', query)
                    .where('email', '<=', query + '\uf8ff')
                    .limit(10)
                    .get();
                
                chatList.innerHTML = '';
                
                usersSnapshot.docs.forEach(doc => {
                    const user = doc.data();
                    if (doc.id === currentUser.uid) return; // Skip current user
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'chat-item';
                    userItem.innerHTML = `
                        <div class="chat-avatar">${user.name.charAt(0).toUpperCase()}</div>
                        <div class="chat-info">
                            <div class="chat-name">${user.name}</div>
                            <div class="chat-preview">${user.email}</div>
                        </div>
                    `;
                    
                    userItem.addEventListener('click', () => startNewChat(doc.id, user));
                    chatList.appendChild(userItem);
                });
                
                if (usersSnapshot.empty) {
                    chatList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #8e8e8e;">
                            <p>No users found</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error searching users:', error);
            }
        });

        async function startNewChat(otherUserId, otherUser) {
            try {
                // Check if chat already exists
                const existingChat = await db.collection('chats')
                    .where('participants', 'array-contains', currentUser.uid)
                    .where('isGroup', '==', false)
                    .get();
                
                let chatId = null;
                existingChat.docs.forEach(doc => {
                    const chat = doc.data();
                    if (chat.participants.includes(otherUserId)) {
                        chatId = doc.id;
                    }
                });
                
                // Create new chat if doesn't exist
                if (!chatId) {
                    const newChatRef = await db.collection('chats').add({
                        participants: [currentUser.uid, otherUserId],
                        isGroup: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    chatId = newChatRef.id;
                }
                
                searchInput.value = '';
                loadChats();
                setTimeout(() => openChat(chatId, otherUser, { isGroup: false, participants: [currentUser.uid, otherUserId] }), 500);
            } catch (error) {
                console.error('Error starting new chat:', error);
                alert('Failed to start chat. Please try again.');
            }
        }

        // Profile menu functionality
        userAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('show');
        });

        document.addEventListener('click', () => {
            profileDropdown.classList.remove('show');
        });

        // Storage info modal
        document.getElementById('storageInfo').addEventListener('click', () => {
            profileDropdown.classList.remove('show');
            showStorageInfo();
        });

        closeStorageModal.addEventListener('click', () => {
            storageModal.classList.remove('show');
        });

        // Admin panel
        document.getElementById('adminPanel').addEventListener('click', () => {
            profileDropdown.classList.remove('show');
            showAdminPanel();
        });

        closeAdminPanel.addEventListener('click', () => {
            adminPanelModal.classList.remove('show');
        });

        // Admin navigation
        document.querySelectorAll('.admin-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                switchAdminSection(section);
            });
        });

        // Close modal when clicking outside
        groupModal.addEventListener('click', (e) => {
            if (e.target === groupModal) {
                groupModal.classList.remove('show');
                selectedUsers.clear();
                groupNameInput.value = '';
                updateCreateGroupButton();
            }
        });

        storageModal.addEventListener('click', (e) => {
            if (e.target === storageModal) {
                storageModal.classList.remove('show');
            }
        });

        adminPanelModal.addEventListener('click', (e) => {
            if (e.target === adminPanelModal) {
                adminPanelModal.classList.remove('show');
            }
        });

        // Storage info functions
        function showStorageInfo() {
            const userStorageBar = document.getElementById('userStorageBar');
            const userStorageUsedSpan = document.getElementById('userStorageUsed');
            
            const percentage = (userStorageUsed / 100) * 100; // 100MB limit per user
            userStorageBar.style.width = Math.min(percentage, 100) + '%';
            userStorageUsedSpan.textContent = userStorageUsed.toFixed(2) + ' MB';
            
            storageModal.classList.add('show');
        }

        // Admin panel functions
        function showAdminPanel() {
            if (!isAdmin) return;
            
            adminPanelModal.classList.add('show');
            loadAdminData();
        }

        function switchAdminSection(section) {
            // Update navigation
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Update sections
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.getElementById(section).classList.add('active');
            
            // Load section data
            if (section === 'users') loadUsersData();
            if (section === 'chats') loadChatsData();
            if (section === 'storage') loadStorageData();
        }

        async function loadAdminData() {
            try {
                // Load dashboard stats
                const usersSnapshot = await db.collection('users').get();
                const chatsSnapshot = await db.collection('chats').get();
                
                let totalMessages = 0;
                let totalStorage = 0;
                
                for (const chatDoc of chatsSnapshot.docs) {
                    const messagesSnapshot = await db.collection('chats').doc(chatDoc.id).collection('messages').get();
                    totalMessages += messagesSnapshot.size;
                }
                
                // Calculate total storage from all users (stored in Cloudinary)
                usersSnapshot.docs.forEach(doc => {
                    const userData = doc.data();
                    totalStorage += userData.storageUsed || 0;
                });
                
                document.getElementById('totalUsers').textContent = usersSnapshot.size;
                document.getElementById('totalChats').textContent = chatsSnapshot.size;
                document.getElementById('totalMessages').textContent = totalMessages;
                document.getElementById('storageUsed').textContent = totalStorage.toFixed(2) + ' MB';
                
                // Update admin storage bar
                const adminStorageBar = document.getElementById('adminStorageBar');
                const adminStorageUsed = document.getElementById('adminStorageUsed');
                const storagePercentage = (totalStorage / 1000) * 100; // 1000MB total limit
                adminStorageBar.style.width = Math.min(storagePercentage, 100) + '%';
                adminStorageUsed.textContent = totalStorage.toFixed(2) + ' MB';
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        async function loadUsersData() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const usersTableBody = document.getElementById('usersTableBody');
                usersTableBody.innerHTML = '';
                
                usersSnapshot.docs.forEach(doc => {
                    const user = doc.data();
                    const joinedDate = user.joinedAt ? new Date(user.joinedAt.toDate()).toLocaleDateString() : 'Unknown';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${joinedDate}</td>
                        <td>
                            <button class="action-btn" onclick="deleteUser('${doc.id}')">Delete</button>
                        </td>
                    `;
                    usersTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users data:', error);
            }
        }

        async function loadChatsData() {
            try {
                const chatsSnapshot = await db.collection('chats').get();
                const chatsTableBody = document.getElementById('chatsTableBody');
                chatsTableBody.innerHTML = '';
                
                for (const doc of chatsSnapshot.docs) {
                    const chat = doc.data();
                    const lastActivity = chat.lastMessageTime ? 
                        new Date(chat.lastMessageTime.toDate()).toLocaleDateString() : 'No activity';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${chat.isGroup ? chat.name : 'Direct Chat'}</td>
                        <td>${chat.isGroup ? 'Group' : 'Direct'}</td>
                        <td>${chat.participants.length}</td>
                        <td>${lastActivity}</td>
                        <td>
                            <button class="action-btn view-btn" onclick="viewChatMessages('${doc.id}')">View</button>
                            <button class="action-btn" onclick="deleteChat('${doc.id}')">Delete</button>
                        </td>
                    `;
                    chatsTableBody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading chats data:', error);
            }
        }

        function loadStorageData() {
            // Storage data is already loaded in loadAdminData
        }

        // Admin action functions
        window.deleteUser = async function(userId) {
            if (!isAdmin) return;
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
            
            try {
                await db.collection('users').doc(userId).delete();
                loadUsersData();
                loadAdminData();
                alert('User deleted successfully');
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        };

        window.deleteChat = async function(chatId) {
            if (!isAdmin) return;
            if (!confirm('Are you sure you want to delete this chat? This action cannot be undone.')) return;
            
            try {
                // Delete all messages in the chat
                const messagesSnapshot = await db.collection('chats').doc(chatId).collection('messages').get();
                const batch = db.batch();
                messagesSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Delete the chat
                await db.collection('chats').doc(chatId).delete();
                
                loadChatsData();
                loadAdminData();
                alert('Chat deleted successfully');
            } catch (error) {
                console.error('Error deleting chat:', error);
                alert('Failed to delete chat');
            }
        };

        window.viewChatMessages = async function(chatId) {
            if (!isAdmin) return;
            
            try {
                const messagesSnapshot = await db.collection('chats').doc(chatId).collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                let messagesText = 'Recent Messages:\n\n';
                messagesSnapshot.docs.forEach(doc => {
                    const message = doc.data();
                    const time = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString() : 'Unknown time';
                    messagesText += `[${time}] ${message.senderName}: ${message.text || message.type}\n`;
                });
                
                alert(messagesText || 'No messages found');
            } catch (error) {
                console.error('Error viewing chat messages:', error);
                alert('Failed to load messages');
            }
        };
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'988d3151b19f025f',t:'MTc1OTUwMjQwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
